# Configurations for determining effects of mutations on antibody/sera escape

# --------------------------------------------------------------------------------------
# Configuration for each antibody selection experiment.
# --------------------------------------------------------------------------------------

# `antibody_selections` is keyed by name of each selection experiment, which includes a
# no-antibody control samples and one or more antibody samples. These should typically
# be from the same library and run on same date. Selection experiments are recommended
# to be named as <Library>-<date as YYMMDD>-<description (eg, antibody)>-<replicate>.
# Each selection experiment should in turn provide the following keys:
#  - `neut_standard_name`: name of neutralization standard in `neut_standard_barcodes`
#  - `no_antibody_sample`: name of the no-antibody sample
#  - `antibody_samples`: a dict keyed by sample name with values of:
#    * `concentration`: the concentration of the antibody
#    * `use_in_fit`: whether to use this sample in the `polyclonal` fit
#  - `prob_escape_filters`: dict giving filters of prob_escape values to use for fitting
#  - `polyclonal_params`: dict giving parameters for `polyclonal` model fitting.
#  - `escape_plot_kwargs`: dict giving parameters for `polyclonal` escape plot
#  - `icXX_plot_kwargs`: dict giving parameters for `polyclonal` ICXX plot
#  - `plot_hide_stats`: dict giving data frames with stats for slider to hide mutations
# The `use_in_fit` option exists because you may decide that some samples are outside
# the preferred neutralization range to include in the fit, so if `use_in_fit: false`
# then functional scores are computed and plotted but it is not included in the fit.

# default prob_escape filters
prob_escape_filters_default: &prob_escape_filters_default
  # error if sample used in fit doesn't have >= this many neut standard counts and
  # >= this fraction of all counts from neut standard.
  min_neut_standard_count: 1000
  min_neut_standard_frac: 0.001
  # Only retain for fitting variants with at least this many counts and this fraction
  # of total counts in the no-antibody sample **OR** the indicated counts and fraction
  # of total counts in the antibody sample.
  min_no_antibody_count: 5  # make bigger for real experiments, say 20
  min_no_antibody_frac: 0.00005  # make smaller for large libraries, say ~0.1 / (library size)
  min_antibody_count: 10  # make bigger for real experiments, say 100
  min_antibody_frac: 0.005  # make smaller for large libraries, say ~10 / (library size)
  # For averaging and plotting the mean probability (fraction) escape across variants, use
  # these cutoffs:
  max_aa_subs: 3  # group variants with >= this many substitutions
  clip_uncensored_prob_escape: 5  # clip uncensored prob escape values at this max

# default parameters for `polyclonal` model fitting
polyclonal_params_default: &polyclonal_params_default
  n_epitopes: 1  # fit this many epitopes, also fit all numbers less than this and plot
  spatial_distances: null  # CSV with residue distances for spatial regularization, or null
  fit_kwargs:  # keyword arguments to `Polyclonal.fit`
    reg_escape_weight: 0.1
    reg_spread_weight: 0.25
    reg_activity_weight: 1.0
    logfreq: 200

# keyword arguments to `Polyclonal.mut_escape_plot`
escape_plot_kwargs_default: &escape_plot_kwargs_default
  addtl_slider_stats:
    times_seen: 3
  addtl_tooltip_stats:
    - sequential_site
  heatmap_max_at_least: 2
  heatmap_min_at_least: -2
  init_floor_at_zero: false
  init_site_statistic: sum
  site_zoom_bar_color_col: region  # supplied in `site_numbering_map`

# Specify any statistics (usually functional effects) for which you want to enable
# sliders that hide data. Keyed by statistic name, then next dict gives:
#   - `csv`: CSV file with the data, should have columns "site" and "mutant"
#   - `csv_col`: column in the CSV with the data
#   - `init`: initial value of slider
plot_hide_stats_default: &plot_hide_stats_default
  functional effect:
    csv: results/func_effects/averages/293T_ACE2_entry_func_effects.csv
    csv_col: effect
    init: -3

# keyword arguments to `Polyclonal.mut_icXX_plot`
icXX_plot_kwargs_default: &icXX_plot_kwargs_default
  <<: *escape_plot_kwargs_default
  x: 0.9
  icXX_col: IC90
  log_fold_change_icXX_col: log2 fold change IC90

# define the antibody selections
antibody_selections:

  LibA-220210-REGN10933-1:
    neut_standard_name: neut_standard
    prob_escape_filters: *prob_escape_filters_default
    polyclonal_params: *polyclonal_params_default
    escape_plot_kwargs: *escape_plot_kwargs_default
    icXX_plot_kwargs: *escape_plot_kwargs_default
    plot_hide_stats: *plot_hide_stats_default
    no_antibody_sample: LibA-220210-no_antibody-1
    antibody_samples:
     LibA-220210-REGN10933-0.15-1:
      concentration: 0.15
      use_in_fit: true
     LibA-220210-REGN10933-1.39-1:
      concentration: 1.39
      use_in_fit: true
     LibA-220210-REGN10933-5.58-1:
      concentration: 5.58
      use_in_fit: true

  LibA-220210-REGN10933-2:
    neut_standard_name: neut_standard
    prob_escape_filters: *prob_escape_filters_default
    polyclonal_params: *polyclonal_params_default
    escape_plot_kwargs: *escape_plot_kwargs_default
    icXX_plot_kwargs: *escape_plot_kwargs_default
    plot_hide_stats: *plot_hide_stats_default
    no_antibody_sample: LibA-220210-no_antibody-2
    antibody_samples:
     LibA-220210-REGN10933-0.15-2:
      concentration: 0.15
      use_in_fit: false
     LibA-220210-REGN10933-1.39-2:
      concentration: 1.39
      use_in_fit: true
     LibA-220210-REGN10933-5.58-2:
      concentration: 5.58
      use_in_fit: true

  LibB-220302-REGN10933-1:
    neut_standard_name: neut_standard
    prob_escape_filters: *prob_escape_filters_default
    polyclonal_params: *polyclonal_params_default
    escape_plot_kwargs: *escape_plot_kwargs_default
    icXX_plot_kwargs: *escape_plot_kwargs_default
    plot_hide_stats: *plot_hide_stats_default
    no_antibody_sample: LibB-220302-no_antibody-1
    antibody_samples:
     LibB-220302-REGN10933-0.15-1:
      concentration: 0.15
      use_in_fit: true
     LibB-220302-REGN10933-1.39-1:
      concentration: 1.39
      use_in_fit: true
     LibB-220302-REGN10933-5.58-1:
      concentration: 5.58
      use_in_fit: true

  LibA-220302-S2M11-1:
    neut_standard_name: neut_standard
    prob_escape_filters: *prob_escape_filters_default
    polyclonal_params: *polyclonal_params_default
    escape_plot_kwargs: *escape_plot_kwargs_default
    icXX_plot_kwargs: *escape_plot_kwargs_default
    plot_hide_stats: *plot_hide_stats_default
    no_antibody_sample: LibA-220302-no_antibody-1
    antibody_samples:
     LibA-220302-S2M11-0.3082-1:
      concentration: 0.3082
      use_in_fit: true
     LibA-220302-S2M11-1.2328-1:
      concentration: 1.2328
      use_in_fit: true
     LibA-220302-S2M11-4.9314-1:
      concentration: 4.9314
      use_in_fit: true

  LibA-220302-S2M11-2:
    neut_standard_name: neut_standard
    prob_escape_filters: *prob_escape_filters_default
    polyclonal_params: *polyclonal_params_default
    escape_plot_kwargs: *escape_plot_kwargs_default
    icXX_plot_kwargs: *escape_plot_kwargs_default
    plot_hide_stats: *plot_hide_stats_default
    no_antibody_sample: LibA-220302-no_antibody-2
    antibody_samples:
     LibA-220302-S2M11-0.3082-2:
      concentration: 0.3082
      use_in_fit: true
     LibA-220302-S2M11-1.2328-2:
      concentration: 1.2328
      use_in_fit: true
     LibA-220302-S2M11-4.9314-2:
      concentration: 4.9314
      use_in_fit: true
