# Building a Custom Homepage

To make the results more accessible, you can improve the default auto-generated documentation of [dms-vep-pipeline-3](https://dms-vep.org/dms-vep-pipeline-3/).
Below, you'll find instructions for building and deploying your own custom [VitePress](https://vitepress.dev/) website where you can customize the display and show key plots and data more clearly.
[Here is an example](https://dms-vep.org/Flu_H5_American-Wigeon_South-Carolina_2021-H5N1_DMS) of such a page.
The default auto-generated documentation will still be available at a different URL as the "appendix" (see details below).

## Process to build a custom homepage

You'll have to make some slight modifications to your project repo to host a [VitePress](https://vitepress.dev/) website as follows:

### Create a `homepage/` directory with required contents

The homepage needs the Markdown content and code used to build the [VitePress](https://vitepress.dev/) site.
This code will live in a new `homepage/` directory at the root of your project; this directory **is** tracked in the GitHub repo.
It is recommended you create an initial template by copying the subdirectory at `dms-vep-pipeline-3/test_example/homepage` to be `homepage` in your repo.
The resulting directory should have the following structure:

```bash
homepage
├── .vitepress
│   ├── config.mjs
│   └── theme
│       ├── Altair.vue
│       ├── Figure.vue
│       ├── index.js
│       ├── parseVegaSpec.js
│       └── style.css
├── README.md
├── antibody_escape.md
├── cell_entry.md
├── .github/workflows/deploy-gh-pages.yaml
├── .gitignore
├── index.md
├── package.json
├── pipeline_information.md
└── public
    └── your-vep.png
```

### Configure your pipeline to use a custom homepage
To configure your pipeline to use a custom homepage, in your top-level `config.yaml` file make sure you set *build_vitepress_homepage* to *true* by having a line like this:

    build_vitepress_homepage: true

Then run the pipeline.
This will create a subdirectory called `./results/homepage` (which should not be tracked in the git repo) which contains the contents of `./homepage` **along** with the auto-generated documentation that the pipeline also creates in `./results/docs` included in `./results/homepage/public` in subdirectories called `htmls` and `notebooks` as well as an `appendix.html` file.

### Previewing the custom homepage

To preview the custom homepage in `./results/homepage`, you'll need to install the Javascript packages used to build and develop the [VitePress](https://vitepress.dev/) site.
We'll use the 'node package manager' (`npm`) to install these packages (this is the package manager for `nodejs`).
You should use version 22 of `nodejs` to match the version in [.github/workflows/deploy-gh-pages.yaml](.github/workflows/deploy-gh-pages.yaml).
For instance, you can create a `conda` environment called *nodejs22* with `nodejs` version 22 by running:

```bash
conda create --name nodejs22 nodejs=22
```

(If you do this you then need to activate the environment with `conda activate nodejs22`).

You then need to do the following steps **in the `./results/homepage` subdirectory** (note that this subdirectory as generated by the pipeline should contain a `package.json` file if you followed the steps above).
Once you are in `./results/homepage`, run:
```bash
npm install
```

You should see that a `package-lock.json` file and `node_modules` subdirectory have been added in this subdirectory.

You can now preview the current documentation by running the following command on the Hutch rhino server:
```bash
npm run remote:docs:dev
```
Or if you're not on the Hutch server, drop the `remote:` part of the command:

```bash
npm run docs:dev
```

Now you'll see a "development server" booted up with a link that looks something like this:
```bash
http://140.107.222.80:42269/<your_repo_name>/
```
The link will look different depending on whether you're running [VitePress](https://vitepress.dev/) locally or on a remote server.
Either way, if you open the link in a web browser you will see the current homepage.

### Developing your homepage content
Initially the homepage you see with the preview process described above is not what you actually want, as the content isn't appropriate for your actual repository.

So now you need to develop your homepage content.
In order to enable previewing of the content via the development view you have created above, you should do this devepment in `./results/homepage` (where you opened the preview), but **you must remember to copy any content you create back to `./homepage`** or it will be deleted next time you run the pipeline.
Only copy back content you create in `./results/homepage` (eg, the `*.md` Markdown files, `./public/your-vep.png` images, and `homepage/.vitepress/config.mjs`); do **not** copy content auto-created by the pipeline (eg, `./public/appendix.html`, `./public/htmls`, `./public/notebooks`).
After you copy back content to `./homepage` you can track it in your main repo, as `./homepage` (but not `./results/homepage`) is tracked in the repo.

As you make your edits, they will show up in the development preview in your web browser.

First, you'll need to replace the default content in the [VitePress](https://vitepress.dev/) config file (`homepage/.vitepress/config.mjs`).

```js
// https://vitepress.dev/reference/site-config
export default defineConfig({
  lang: "en-US",
  title: "Homepage for my favorite viral entry protein",
  description:
    "Data, figures, and analysis for DMS of my favorite viral entry protein.",
  base: "/my_virus_dms/",
  themeConfig: {
    nav: [
      { text: "Home", link: "/" },
      { text: "Appendix", link: "/appendix", target: "_self" },
    ],
    socialLinks: [{ icon: "github", link: "https://github.com/dms-vep" }],
    footer: {
      message: "Copyright © 2024-present Me and Jesse Bloom",
    },
  },
});
```

Replace the `title` and `description` with content that suits your project. Add your name to the copyright message in the `footer`. Change the `link` under `socialLinks` to your project's GitHub repo. Finally, replace the `base` path with the name of your repository. Setting the `base` path correctly is essential for hosting your site.

The landing page for your [VitePress](https://vitepress.dev/) site is determined by the `index.md` file. Edit this file to change the title add an image of your viral entry protein and link to pages describing your results.

```yml
layout: home

hero:
  name: "My Favorite Virus' Receptor DMS"
  tagline: "A collection of data, figures, and information for DMS of my favorite viral entry protein"
  image: your-vep.png
features:
  - title: Antibody Escape
    details: Example link to antibody escape data
    link: /antibody_escape
  - title: Cell Entry
    details: Example link to functional selection data
    link: /cell_entry
  - title: Pipeline Information
    details: Example page detailing computational pipeline
    link: /pipeline_information
```

The `index.md` file, like every Markdown page of your site, is comprised of two parts: optional `yaml` 'frontmatter' and Markdown content. In the case of the `index.md`, the content of the page is dictated solely by the `yaml` 'frontmatter'. In the rest of the pages, you'll write Markdown content with some minor configuration through the `yaml` 'frontmatter'. 

Check out the [VitePress Writing guide](https://vitepress.dev/guide/markdown) for details on writing pages and configuring them with 'frontmatter'.

You add pages to your website by writing Markdown documents in the `homepage/` directory. VitePress will convert these Markdown documents into `html` and render them as pages on your website. You can link to these pages in your `index.md` (or anywhere else on the site) using their path with the `.md` extension omitted. For example, if you write a page with details about antibody escape called `antibody_escape.md`, the `/antibody_escape` path will bring you to that page.

As mentioned above, each page is a simple [Markdown document](https://vitepress.dev/guide/markdown) configured with[ `yaml` frontmatter](https://vitepress.dev/guide/frontmatter). However, there are some key points to keep in mind.

For one, if you reference a link to an `html` file created by the pipeline like an `Altair` plot, you'll need to tell VitePress that you're linking to a *local* file and not a *remote* URL. You do this by adding the `target="_self"` directive after the relevant Markdown link.

```md
[LibA-220210-REGN10933-1](notebooks/fit_escape_antibody_escape_LibA-220210-REGN10933-1.html){target="_self"}
```

You can also render interactive `Altair` plots directly on a page with a custom component that I added to `homepage/.vitepress`.

```html
<Figure caption="Effects of mutations on antibody neutralization by REGN10933">
    <Altair :showShadow="true" :spec-url="'htmls/REGN10933_mut_effect.html'"></Altair>
</Figure>
```

The code above will render the `Altair` plot `htmls/REGN10933_mut_effect.html` in an expandable widget on the page with the figure caption "Effects of mutations on antibody neutralization by REGN10933" beneath it.

### Be sure to save your content in `./homepage`
As mentioned above, you are editing your site in `./results/homepage`, but be sure to copy any Markdown or other content you create back to `./homepage` and track it in the git repo.
That way when you run the pipeline again and it auto-generates `./results/homepage` that content will be there.

## Under the hood
Here is what is happening under the hood:

 - The pipeline creates auto-documentation in `./results/docs`
 - The pipeline then creates `./results/homepage` from the content you created in `./homepage` plus the auto-documentation in `./results/docs`, putting the auto-documentation in `./results/homepage/public` and renaming `index.html` to `appendix.html`.
 - The pipeline then creates `./results/publish_docs` as a copy of `./results/homepage` (this is needed to also be compatible with publishing the docs with no homepage.
 - Later when you run `./dms-vep-pipeline-3/publish_docs_gh-pages.sh` the contents of `./results/publish_docs` are put on a new *gh-pages* branch that can be viewed via GitHub Pages as described in the main [https://github.com/dms-vep/dms-vep-pipeline-3](https://github.com/dms-vep/dms-vep-pipeline-3) README.

## Adding Google Analytics
If you want to add Google Analytics to your site, you can do this to see how many people have visited it.
To do this, first you need to use your Google account to create a Google Analytics tag.
Once you have done that, you can add it to the `.vitepress/config.mjs` file as indicated below (in that example, `G-P7HL8Q4F41` is the Google Analytics tag; you will get a different tag when you create yours:

      head: [
        [
          "script",
          { async: "", src: "https://www.googletagmanager.com/gtag/js?id=G-P7HL8Q4F41" }
        ],
        [
          "script",
          {},
          `window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag("js", new Date());
          gtag("config", "G-P7HL8Q4F41");`
        ]
      ],
